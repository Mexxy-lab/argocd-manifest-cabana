// pipeline {
//     agent any

//     environment {
//         IMAGE = 'pumejlab/cabana'
//     }

//     stages {
//         stage('Clone repository') {
//             steps {
//                 git branch: 'main', url: 'https://github.com/Mexxy-lab/argocd-manifest-cabana.git'
//             }
//         }

//         stage('Update GIT') {
//             steps {
//                 script {
//                     catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
//                         withCredentials([usernamePassword(credentialsId: 'pumej-gitpasswd', passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME')]) {
//                             sh "git config user.email pumej1985@gmail.com"
//                             sh "git config user.name Mexxy-lab"
//                             sh "cat deployment.yml"
//                             sh "sed -i 's+${env.IMAGE}.*+${env.IMAGE}:${env.DOCKERTAG}+g' deployment.yml"
//                             sh "cat deployment.yml"
//                             sh "git add ."
//                             sh "git commit -m 'Done by Jenkins Job changemanifest: ${env.BUILD_NUMBER}'"
//                             sh 'git push https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/Mexxy-lab/argocd-manifest-cabana.git HEAD:main'
//                         }
//                     }
//                 }
//             }
//         }
//     }
// }

node {
    //This is a groovy scripted language
    def app

    env.IMAGE = '598189530267.dkr.ecr.ap-south-1.amazonaws.com/pumejcabana'

    stage('Clone repository') {
             git branch: 'main', url: 'https://github.com/Mexxy-lab/argocd-manifest-cabana.git'
    }

    stage('Update GIT') {
            script {
                catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                    withCredentials([usernamePassword(credentialsId: 'pumej-gitpasswd', passwordVariable: 'GIT_PASSWORD', usernameVariable: 'GIT_USERNAME')]) {
                        //script {def encodedPassword = URLEncoder.encode("$GIT_PASSWORD",'UTF-8')}
                        //script  {def IMAGE='pumejlab/amazon'}
                        sh "git config user.email pumej1985@gmail.com"
                        sh "git config user.name Mexxy-lab"
                        //sh "git switch master"
                        sh "cat deployment.yml"
                        //This command used to substitute the image name to new one that was pushed. From latest to Jenkins build number.
                        sh "sed -i 's+${IMAGE}.*+${IMAGE}:${DOCKERTAG}+g' deployment.yml"
                        sh "cat deployment.yml"
                        sh "git add ."
                        sh "git commit -m 'Done by Jenkins Job changemanifest: ${env.BUILD_NUMBER}'"
                        sh 'git push https://${GIT_USERNAME}:${GIT_PASSWORD}@github.com/${GIT_USERNAME}/argocd-manifest-cabana.git HEAD:main'
             }
         }
     }
  }
}